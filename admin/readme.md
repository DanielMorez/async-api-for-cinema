# Админ-панель для управления рассылками

Наивная реализация сервиса. 
В идеале мы понимаем, что большая часть рассылок должна быть автоматизирована, но это 
предполагает создание дополнительных сервисов или значительной доработки существующих (например, допилить UGC API, 
auth API), чтобы они возвращали какие-то агрегированные данные по конкретному юзеру (просмотренные фильмы за неделю, 
месяц, любимые жанры и т.д.).

С другой стороны, нас в команде двое и мы должны уделить внимание работе именно работе с системой уведомлений, а не с 
созданием отсутствующих связей между сервисами. Поэтому админ-панель несколько упрощена.

Trade-off как он есть :)

## Функционал: 
- контент-менеджер заходит в админку, 
- создает шаблон для рассылки или выбирает существующий 
- создает задание, добавляет в него шаблон, контекст, список и категории пользователей, устанавливает приоритет и время отправки.

### Шаблон рассылки / уведомления

Шаблон привязан к типу транспорта для уведомления (это может быть sms, email, etc)

Например:

```json
[
  {
    "id": 1,
    "title": "welcome letter",
    "code": "welcome_letter",
    "template": "<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <title>welcome letter</title>\r\n</head>\r\n<body>\r\n  <h1>Dear {{ username }}</h1>\r\n  <p>We are glad to welcome you to the FakeNetflix website! </p>\r\n  <p>Verify your account by clicking on the link: {{ short_link }}</p>\r\n</body>\r\n</html>",
    "subject": "welcome letter",
    "transport": "email"
    "created_at": "2022-01-17 14:56:01.590664 +00:00",
    "updated_at": "2022-01-17 14:56:01.590669 +00:00"
  },
  {
    "id": 3,
    "title": "security sms",
    "code": "security_notification",
    "template": "Hello, {{ context }}!\r\nYour password has been compromised",
    "subject": "FakeNetflix",
    "created_at": "2022-01-17 15:16:29.495836 +00:00",
    "updated_at": "2022-01-17 15:16:29.495848 +00:00"
  }
]
```

### Задание рассылки

MailingTask имеет следующий вид:

```json
[
  {
    "id": 1,
    "status": "pending",
    "is_promo": true,
    "priority": "low",
    "context": "{\"films\": [\"380164b8-7503-4c15-b83d-88de95743880\", \"b0a67781-567c-407d-8c30-4f9d49325d88\", \"35936f0f-6aa5-4d03-afb3-a7e0ad099a66\"], \"user_ids\": [\"eba6db18-02ca-496a-ad70-f16fc876cd2a\", \"c15c61d0-1543-49b5-bfb9-c2743b3079e3\"], \"user_categories\": [\"active\"]}",
    "scheduled_datetime": "2022-02-01 18:00:00.000000 +00:00",
    "execution_datetime": null,
    "created_at": "2022-01-17 15:08:55.182155 +00:00",
    "updated_at": "2022-01-17 15:08:55.182167 +00:00",
    "template_id": 2,
  }
]
```

Мы можем выбрать приоритет для рассылки, способ рассылки, статический контент для одинаковых писем, выбрать является ли 
рассылка рекламной, выбрать время доставки письма пользователем.


### Расширяемость

Сначала мы планировали в Postgres хранить модель "транспорта" для уведомлений, чтобы админы могли сами управлять 
способами передачи уведомлений. Но в ходе обсуждений пришли к мысли, что вмешательство программиста будет необходимо в 
любом случае (например, написание сендера под конкретный "вид транспорта"). Поэтому остановились на том, что 
программист дополняет модельку:

```python
class Transport(models.TextChoices):
    sms = 'sms'
    email = 'email'
```

Мы дополняем воркера под особенности конкретного "транспорта", если SMS, то `subject` не будет, но можно передавать в 
качестве отправителя что-то человекочитаемое (например, FakeNetflix).

Также в воркере пишем сендер под этот вид транспорта, например, элементарный клиент для `Twilio`. 

В результате будет что-то типа:
```python
if event.transport == SMS:
    self.sms_sender.send(user_info.phone, item_to_send)
```

## Тестовые данные

Загрузить в базу

```shell
cd admin/src
python manage.py loaddata fixtures/admin_panel_data.json
```

Дампнуть из базы

```shell
cd admin/src
python manage.py dumpdata admin_panel > fixtures/admin_panel_data.json
```